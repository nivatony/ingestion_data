{"paragraphs":[{"text":"%pyspark\n## GlueNotebook1 - MySQL2Redshift.\nprint spark.version\nsys.argv=[\"mysql2redshift.py\",\"--JOB_NAME\",\"MySQL2Redshift\",\"--TempDir\",\"s3://neilawsglue/temp\"]","user":"admin","dateUpdated":"2017-10-30T02:01:17+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"2.1.0\n"}]},"apps":[],"jobName":"paragraph_1509313551431_381228597","id":"20171029-214551_659870812","dateCreated":"2017-10-29T21:45:51+0000","dateStarted":"2017-10-30T02:01:17+0000","dateFinished":"2017-10-30T02:01:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1277"},{"text":"%pyspark\n## Glue Job starts here\nimport sys, boto3\nfrom awsglue.context import DynamicFrame,GlueContext\nfrom pyspark.sql.functions import UserDefinedFunction\nfrom pyspark.sql.types import StringType\nfrom awsglue.transforms import ApplyMapping,SelectFields\nfrom awsglue.job import Job\nfrom pyspark.sql.types import DecimalType\nfrom awsglue.utils import getResolvedOptions\nfrom awsglue.context import GlueContext, DynamicFrame\nfrom pyspark.context import SparkContext\n\nargs = getResolvedOptions(sys.argv, ['TempDir','JOB_NAME'])\n\nsc=sc if 'sc' in vars() else SparkContext()\nglueContext = GlueContext(sc)\nspark = glueContext.spark_session\njob = Job(glueContext)\njob.init(args['JOB_NAME'], args)\n","user":"admin","dateUpdated":"2017-10-30T02:01:17+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1509313628932_856332192","id":"20171029-214708_488066161","dateCreated":"2017-10-29T21:47:08+0000","dateStarted":"2017-10-30T02:01:17+0000","dateFinished":"2017-10-30T02:01:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1278"},{"text":"%pyspark\n### *** CHANGE THESE *** ###\n## Glue database references\nsource_database=\"mysqldb\"\ntarget_database=\"redshift\"\n\n## Glue table references\nsource_tables= [\"auroradb_sales_order_detail_af48b305\", \"auroradb_sales_order_cdacc40b\"]\ntarget_tables= [\"redshiftdb4_public_sales_order_fact\"]\n","user":"admin","dateUpdated":"2017-10-30T02:01:17+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1509313644557_-1057393513","id":"20171029-214724_703708834","dateCreated":"2017-10-29T21:47:24+0000","dateStarted":"2017-10-30T02:01:17+0000","dateFinished":"2017-10-30T02:01:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1279"},{"text":"%pyspark\ndatasource0 = glueContext.create_dynamic_frame.from_catalog(database = source_database, table_name = source_tables[0], transformation_ctx = \"datasource0\")\nprint \"Rows read from mysql table: +\"+source_tables[0]+\" : \"+str(datasource0.count())\ndatasource0.printSchema()","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Rows read from mysql table: +auroradb_sales_order_detail_af48b305 : 98000\nroot\n|-- LINE_ID: int\n|-- LINE_NUMBER: int\n|-- ORDER_ID: int\n|-- PRODUCT_ID: int\n|-- QUANTITY: int\n|-- UNIT_PRICE: decimal\n|-- DISCOUNT: decimal\n|-- SUPPLY_COST: decimal\n|-- TAX: decimal\n\n"}]},"apps":[],"jobName":"paragraph_1509314868512_-361649318","id":"20171029-220748_1904695834","dateCreated":"2017-10-29T22:07:48+0000","dateStarted":"2017-10-30T02:01:18+0000","dateFinished":"2017-10-30T02:01:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1280"},{"text":"%pyspark\ndatasource1 = glueContext.create_dynamic_frame.from_catalog(database = source_database, table_name = source_tables[1], transformation_ctx = \"datasource1\")\nprint \"Rows read from mysql table: +\"+source_tables[1]+\" : \"+str(datasource1.count())\ndatasource1.printSchema()\n","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Rows read from mysql table: +auroradb_sales_order_cdacc40b : 29000\nroot\n|-- ORDER_ID: int\n|-- SITE_ID: double\n|-- ORDER_DATE: timestamp\n|-- SHIP_MODE: string\n\n"}]},"apps":[],"jobName":"paragraph_1509317185035_473361420","id":"20171029-224625_309962189","dateCreated":"2017-10-29T22:46:25+0000","dateStarted":"2017-10-30T02:01:18+0000","dateFinished":"2017-10-30T02:01:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1281"},{"text":"%pyspark\n#DynamicFrame join\ndatasource2=datasource1.join( [\"ORDER_ID\"],[\"ORDER_ID\"], datasource0, transformation_ctx = \"join\")\n#Spark DataFrame join\n#df2=datasource1.toDF().join(datasource0.toDF(),\"ORDER_ID\")\n#datasource2_1=DynamicFrame.fromDF(df2, glueContext,'datasource2_1')\nprint \" Rows after Join transform: \"+str(datasource2.count())\ndatasource2.printSchema()","user":"admin","dateUpdated":"2017-10-30T02:01:19+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":" Rows after Join transform: 98000\nroot\n|-- SITE_ID: double\n|-- SHIP_MODE: string\n|-- TAX: decimal\n|-- ORDER_DATE: timestamp\n|-- ORDER_ID: int\n|-- LINE_NUMBER: int\n|-- SUPPLY_COST: decimal\n|-- DISCOUNT: decimal\n|-- .ORDER_ID: int\n|-- LINE_ID: int\n|-- PRODUCT_ID: int\n|-- QUANTITY: int\n|-- UNIT_PRICE: decimal\n\n"}]},"apps":[],"jobName":"paragraph_1509317207442_-825904968","id":"20171029-224647_216689847","dateCreated":"2017-10-29T22:46:47+0000","dateStarted":"2017-10-30T02:01:19+0000","dateFinished":"2017-10-30T02:01:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1282"},{"text":"%pyspark\n## Adding computed columns\nmultiply_udf = UserDefinedFunction(lambda x,y : x * y, DecimalType(10,2))\ncompute_profit_udf = UserDefinedFunction(lambda x,y,z : x * (y-z), DecimalType(10,2))\n\ndf1=datasource2.toDF().withColumn(\"EXTENDED_PRICE\",multiply_udf(\"QUANTITY\",\"UNIT_PRICE\")).withColumn(\"PROFIT\",compute_profit_udf(\"QUANTITY\",\"UNIT_PRICE\",\"SUPPLY_COST\"))\ndatasource3=DynamicFrame.fromDF(df1, glueContext,'datasource3')\ndf1.printSchema()\n","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- SITE_ID: double (nullable = true)\n |-- SHIP_MODE: string (nullable = true)\n |-- TAX: decimal(11,10) (nullable = true)\n |-- ORDER_DATE: timestamp (nullable = true)\n |-- ORDER_ID: integer (nullable = true)\n |-- LINE_NUMBER: integer (nullable = true)\n |-- SUPPLY_COST: decimal(12,10) (nullable = true)\n |-- DISCOUNT: decimal(11,10) (nullable = true)\n |-- .ORDER_ID: integer (nullable = true)\n |-- LINE_ID: integer (nullable = true)\n |-- PRODUCT_ID: integer (nullable = true)\n |-- QUANTITY: integer (nullable = true)\n |-- UNIT_PRICE: decimal(12,10) (nullable = true)\n |-- EXTENDED_PRICE: decimal(10,2) (nullable = true)\n |-- PROFIT: decimal(10,2) (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1509317984540_734170268","id":"20171029-225944_958131121","dateCreated":"2017-10-29T22:59:44+0000","dateStarted":"2017-10-30T02:01:19+0000","dateFinished":"2017-10-30T02:01:26+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1283"},{"text":"%pyspark\napplymapping1 = ApplyMapping.apply(frame = datasource3, mappings = [(\"DISCOUNT\", \"decimal(10,2)\", \"discount\", \"decimal(10,2)\"), (\"UNIT_PRICE\", \"decimal(10,2)\", \"unit_price\", \"decimal(10,2)\"), (\"TAX\", \"decimal(10,2)\", \"tax\", \"decimal(10,2)\"), (\"SUPPLY_COST\", \"decimal(10,2)\", \"supply_cost\", \"decimal(10,2)\"), (\"PRODUCT_ID\", \"int\", \"product_id\", \"int\"), (\"QUANTITY\", \"int\", \"quantity\", \"int\"), (\"LINE_ID\", \"int\", \"line_id\", \"int\"), (\"LINE_NUMBER\", \"int\", \"line_number\", \"int\"), (\"ORDER_DATE\", \"timestamp\", \"order_date\", \"timestamp\"), (\"SHIP_MODE\", \"string\", \"ship_mode\", \"string\"), (\"SITE_ID\", \"double\", \"site_id\", \"int\"), (\"PROFIT\", \"decimal(10,2)\", \"profit\", \"decimal(10,2)\"),(\"EXTENDED_PRICE\", \"decimal(10,2)\", \"extended_price\", \"decimal(10,2)\"),(\"ORDER_ID\", \"int\", \"order_id\", \"int\")], transformation_ctx = \"applymapping1\")\nprint \"After ApplyMapping :\"\napplymapping1.printSchema()\napplymapping1.toDF().show(5)\n","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"After ApplyMapping :\nroot\n|-- discount: decimal\n|-- unit_price: decimal\n|-- tax: decimal\n|-- supply_cost: decimal\n|-- product_id: int\n|-- quantity: int\n|-- line_id: int\n|-- line_number: int\n|-- order_date: timestamp\n|-- ship_mode: string\n|-- site_id: int\n|-- profit: decimal\n|-- extended_price: decimal\n|-- order_id: int\n\n+--------+----------+----+-----------+----------+--------+-------+-----------+--------------------+---------+-------+-------+--------------+--------+\n|discount|unit_price| tax|supply_cost|product_id|quantity|line_id|line_number|          order_date|ship_mode|site_id| profit|extended_price|order_id|\n+--------+----------+----+-----------+----------+--------+-------+-----------+--------------------+---------+-------+-------+--------------+--------+\n|    0.00|     28.00|1.00|      13.00|       727|     133|  22840|          1|2015-03-02 00:00:...|  TWO-DAY|   1695|1995.00|       3724.00|    7425|\n|    2.00|     73.00|0.00|      43.00|       215|      80|   7425|          1|2015-03-02 00:00:...|  TWO-DAY|   1695|2400.00|       5840.00|    7425|\n|    2.00|     22.00|0.00|      11.00|       364|     102|  15586|          1|2015-03-02 00:00:...|  TWO-DAY|   1695|1122.00|       2244.00|    7425|\n|    7.00|     77.00|0.00|      35.00|       853|      55|  28475|          1|2015-03-02 00:00:...|  TWO-DAY|   1695|2310.00|       4235.00|    7425|\n|    4.00|     41.00|1.00|      20.00|       908|      70|  28178|          1|2015-03-02 00:00:...|  TWO-DAY|   1695|1470.00|       2870.00|    7425|\n+--------+----------+----+-----------+----------+--------+-------+-----------+--------------------+---------+-------+-------+--------------+--------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1509318024078_2112587659","id":"20171029-230024_118629587","dateCreated":"2017-10-29T23:00:24+0000","dateStarted":"2017-10-30T02:01:26+0000","dateFinished":"2017-10-30T02:01:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1284"},{"text":"%pyspark\nselectfields2 = SelectFields.apply(frame = applymapping1, paths = [\"quantity\", \"discount\", \"tax\", \"unit_price\", \"line_id\", \"date_key\", \"order_date\", \"extended_price\", \"ship_mode\", \"line_number\", \"product_id\", \"site_id\", \"supply_cost\", \"order_id\", \"profit\"], transformation_ctx = \"selectfields2\")\nprint \"After SelectFields :\"\nselectfields2.toDF().show(5)\n","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"After SelectFields :\n+--------+--------+----+----------+-------+--------------------+--------------+---------+-----------+----------+-------+-----------+--------+-------+\n|quantity|discount| tax|unit_price|line_id|          order_date|extended_price|ship_mode|line_number|product_id|site_id|supply_cost|order_id| profit|\n+--------+--------+----+----------+-------+--------------------+--------------+---------+-----------+----------+-------+-----------+--------+-------+\n|     133|    0.00|1.00|     28.00|  22840|2015-03-02 00:00:...|       3724.00|  TWO-DAY|          1|       727|   1695|      13.00|    7425|1995.00|\n|      80|    2.00|0.00|     73.00|   7425|2015-03-02 00:00:...|       5840.00|  TWO-DAY|          1|       215|   1695|      43.00|    7425|2400.00|\n|     102|    2.00|0.00|     22.00|  15586|2015-03-02 00:00:...|       2244.00|  TWO-DAY|          1|       364|   1695|      11.00|    7425|1122.00|\n|      55|    7.00|0.00|     77.00|  28475|2015-03-02 00:00:...|       4235.00|  TWO-DAY|          1|       853|   1695|      35.00|    7425|2310.00|\n|      70|    4.00|1.00|     41.00|  28178|2015-03-02 00:00:...|       2870.00|  TWO-DAY|          1|       908|   1695|      20.00|    7425|1470.00|\n+--------+--------+----+----------+-------+--------------------+--------------+---------+-----------+----------+-------+-----------+--------+-------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1509318070456_-1423377326","id":"20171029-230110_2014251346","dateCreated":"2017-10-29T23:01:10+0000","dateStarted":"2017-10-30T02:01:26+0000","dateFinished":"2017-10-30T02:01:47+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1285"},{"text":"%pyspark\ndatasink3 = glueContext.write_dynamic_frame.from_catalog(frame = selectfields2, database = target_database, table_name = target_tables[0], redshift_tmp_dir = args[\"TempDir\"], transformation_ctx = \"datasink3\")\nprint \"Rows inserted into Redshift table: \"+target_tables[0]+\" : \"+str(datasink3.count())\n\n","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Rows inserted into Redshift table: redshiftdb4_public_sales_order_fact : 98000\n"}]},"apps":[],"jobName":"paragraph_1509318095956_1551931891","id":"20171029-230135_937397672","dateCreated":"2017-10-29T23:01:35+0000","dateStarted":"2017-10-30T02:01:34+0000","dateFinished":"2017-10-30T02:02:26+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1286"},{"text":"%pyspark\nprint args['JOB_NAME']+\" END...\"\njob.commit()","user":"admin","dateUpdated":"2017-10-30T02:01:48+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"MySQL2Redshift END...\n"}]},"apps":[],"jobName":"paragraph_1509318120596_760149303","id":"20171029-230200_1426171598","dateCreated":"2017-10-29T23:02:00+0000","dateStarted":"2017-10-30T02:01:48+0000","dateFinished":"2017-10-30T02:02:26+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1287"},{"text":"%pyspark\n","user":"admin","dateUpdated":"2017-10-30T02:01:18+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509318185203_564220168","id":"20171029-230305_1147125500","dateCreated":"2017-10-29T23:03:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1288"}],"name":"GlueNotebook2-MySQL2Redshift","id":"2CXW26R75","angularObjects":{"2CX47D48X:shared_process":[],"2CX1GAB23:shared_process":[],"2CXAS486E:shared_process":[],"2CWXPWV4T:shared_process":[],"2CWYDBW8W:shared_process":[],"2CX62G2V9:shared_process":[],"2CXZHAZWD:shared_process":[],"2CXFJD9GB:shared_process":[],"2CXADFFZU:shared_process":[],"2CXWRUPRH:shared_process":[],"2CZMFTXQ8:shared_process":[],"2CXWPFN31:shared_process":[],"2CXZ6R975:shared_process":[],"2CYGKGR4E:shared_process":[],"2CXA9982P:shared_process":[],"2CVSH4A8W:shared_process":[],"2CW5H3N8R:shared_process":[],"2CWPK2ADG:shared_process":[],"2CYVSKTUG:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}